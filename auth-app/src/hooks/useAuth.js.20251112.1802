import { useState, useEffect, useCallback } from 'react';

export function useAuth() {
  // État en mémoire uniquement (pas de localStorage)
  const [authState, setAuthState] = useState({
    token: null,
    userData: null,
    tokenExpiry: null,
    isAuthenticated: false
  });
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Décodage JWT
  const decodeJWT = useCallback((token) => {
    try {
      const payload = token.split('.')[1];
      return JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
    } catch {
      return null;
    }
  }, []);

  // Calcul du temps restant
  const getRemainingTime = useCallback(() => {
    if (!authState.tokenExpiry) return '';
    
    const remaining = Math.max(0, authState.tokenExpiry - Date.now());
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    if (minutes > 0) {
      return `${minutes}min ${seconds}s`;
    }
    return `${seconds}s`;
  }, [authState.tokenExpiry]);

  // Vérification de l'expiration du token
  useEffect(() => {
    if (!authState.tokenExpiry) return;

    const checkExpiry = () => {
      const now = Date.now();
      if (now >= authState.tokenExpiry) {
        logout();
        setError('Votre session a expiré. Veuillez vous reconnecter.');
      }
    };

    const interval = setInterval(checkExpiry, 1000);
    return () => clearInterval(interval);
  }, [authState.tokenExpiry]);

  // Connexion
  const login = async (username, password) => {
    setError('');
    setLoading(true);

    try {
      const params = new URLSearchParams({
        grant_type: 'password',
        username,
        password,
        client_id: 'FBI-Appli-Demo'
      });

      const response = await fetch('http://localhost:8000/oauth/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });

      const data = await response.json();

      if (response.ok) {
        const token = data.access_token || data.token;
        const decoded = decodeJWT(token);

        if (!decoded) {
          throw new Error('Token invalide');
        }

        let expiryTime;
        if (data.expires_in) {
          expiryTime = Date.now() + (data.expires_in * 1000);
        } else if (decoded.exp) {
          expiryTime = decoded.exp * 1000;
        } else {
          expiryTime = Date.now() + (3600 * 1000); // 1h par défaut
        }

        setAuthState({
          token,
          userData: decoded,
          tokenExpiry: expiryTime,
          isAuthenticated: true
        });

        return { success: true };
      } else {
        setError('Identifiants incorrects');
        return { success: false, error: 'Identifiants incorrects' };
      }
    } catch (err) {
      const errorMsg = 'Erreur de connexion au serveur';
      setError(errorMsg);
      return { success: false, error: errorMsg };
    } finally {
      setLoading(false);
    }
  };

  // Déconnexion
  const logout = useCallback(() => {
    setAuthState({
      token: null,
      userData: null,
      tokenExpiry: null,
      isAuthenticated: false
    });
    setError('');
  }, []);

  // Helpers
  const getRoles = useCallback(() => {
    const rolesStr = authState.userData?.roles || authState.userData?.rolesApplicatifs || '';
    return rolesStr ? rolesStr.split(':') : [];
  }, [authState.userData]);

  const isAdmin = useCallback(() => {
    return getRoles().includes('ADMIN');
  }, [getRoles]);

  const getName = useCallback(() => {
    if (authState.userData?.firstName && authState.userData?.lastName) {
      return `${authState.userData.lastName} ${authState.userData.firstName}`;
    }
    return authState.userData?.displayname || authState.userData?.principal || authState.userData?.uid || '';
  }, [authState.userData]);

  const getCodeUA = useCallback(() => {
    return authState.userData?.CodeUA || '';
  }, [authState.userData]);

  return {
    // État
    isAuthenticated: authState.isAuthenticated,
    userData: authState.userData,
    tokenExpiry: authState.tokenExpiry,
    loading,
    error,
    
    // Actions
    login,
    logout,
    
    // Helpers
    getRemainingTime,
    getRoles,
    isAdmin,
    getName,
    getCodeUA,
    setError
  };
}
